<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آزمون‌ساز حرفه‌ای با SQLite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@tailwindcss/forms@0.5.3/dist/forms.min.css" rel="stylesheet">
    <!-- SQL.js برای پیاده‌سازی SQLite در مرورگر -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95',
                        }
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
        
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        
        .dark {
            color-scheme: dark;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* سفارشی سازی scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #4B5563;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
        
        /* استایل‌های سفارشی برای نمایش فایل */
        .file-preview {
            max-width: 100%;
            max-height: 200px;
            margin: 0 auto;
            display: block;
        }
        
        .option-container:hover {
            background-color: rgba(139, 92, 246, 0.05);
        }
        
        .dark .option-container:hover {
            background-color: rgba(139, 92, 246, 0.1);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white mb-2">آزمون‌ساز حرفه‌ای</h1>
            <p class="text-gray-600 dark:text-gray-300">ساخت، اشتراک‌گذاری و مدیریت آزمون‌ها به سادگی</p>
        </header>

        <!-- نمایش لودینگ هنگام آماده‌سازی دیتابیس -->
        <div id="loading-view" class="text-center p-10">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 dark:border-primary-500 mb-4"></div>
            <p class="text-gray-600 dark:text-gray-300">در حال آماده‌سازی دیتابیس...</p>
        </div>

        <!-- Views Container -->
        <div id="views" class="hidden">
            <!-- Home View -->
            <div id="home-view" class="fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">به آزمون‌ساز خوش آمدید</h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">با استفاده از این ابزار می‌توانید به راحتی آزمون‌های خود را بسازید، به اشتراک بگذارید و نتایج را مشاهده کنید.</p>
                    <div class="flex flex-col md:flex-row gap-4">
                        <button id="create-quiz-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex-1">
                            ساخت آزمون جدید
                        </button>
                        <button id="take-quiz-btn" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex-1">
                            شرکت در آزمون
                        </button>
                        <button id="my-quizzes-btn" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex-1">
                            آزمون‌های من
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <div class="text-primary-600 dark:text-primary-400 text-4xl mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-center text-gray-800 dark:text-white mb-2">ساخت آزمون</h3>
                        <p class="text-gray-600 dark:text-gray-300 text-center">سوالات چندگزینه‌ای بسازید و آزمون خود را به راحتی طراحی کنید.</p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <div class="text-primary-600 dark:text-primary-400 text-4xl mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-center text-gray-800 dark:text-white mb-2">به اشتراک‌گذاری</h3>
                        <p class="text-gray-600 dark:text-gray-300 text-center">کد آزمون را با دیگران به اشتراک بگذارید تا در آن شرکت کنند.</p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <div class="text-primary-600 dark:text-primary-400 text-4xl mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-center text-gray-800 dark:text-white mb-2">مشاهده نتایج</h3>
                        <p class="text-gray-600 dark:text-gray-300 text-center">نتایج و آمار شرکت‌کنندگان را به صورت دقیق بررسی کنید.</p>
                    </div>
                </div>
            </div>

            <!-- Create Quiz View -->
            <div id="create-quiz-view" class="hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ساخت آزمون جدید</h2>
                        <button id="back-to-home-btn" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <form id="quiz-form" class="space-y-6">
                        <div>
                            <label for="quiz-title" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">عنوان آزمون</label>
                            <input type="text" id="quiz-title" name="quiz-title" placeholder="مثال: آزمون ریاضی پایه هفتم" required
                                class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label for="quiz-description" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">توضیحات آزمون</label>
                            <textarea id="quiz-description" name="quiz-description" rows="3" placeholder="توضیحات مربوط به آزمون را وارد کنید..."
                                class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                        </div>
                        
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">سوالات آزمون</h3>
                            <div id="questions-container" class="space-y-6">
                                <!-- Questions will be added here dynamically -->
                            </div>
                            
                            <button type="button" id="add-question-btn" class="mt-4 inline-flex items-center text-primary-600 dark:text-primary-400 font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                افزودن سوال جدید
                            </button>
                        </div>
                        
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">تنظیمات آزمون</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="quiz-time" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">مدت زمان آزمون (دقیقه)</label>
                                    <input type="number" id="quiz-time" name="quiz-time" min="1" value="30"
                                        class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div>
                                    <label for="quiz-passing-score" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">نمره قبولی (درصد)</label>
                                    <input type="number" id="quiz-passing-score" name="quiz-passing-score" min="0" max="100" value="60"
                                        class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div>
                                    <label for="quiz-attempts" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">محدودیت شرکت در آزمون</label>
                                    <select id="quiz-attempts" name="quiz-attempts" 
                                        class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="1">فقط یک بار</option>
                                        <option value="10">10 بار</option>
                                        <option value="0" selected>بدون محدودیت</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end pt-6">
                            <button type="submit" id="save-quiz-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                                ذخیره و ساخت آزمون
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Take Quiz View -->
            <div id="take-quiz-view" class="hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">شرکت در آزمون</h2>
                        <button id="back-from-take-quiz" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div id="quiz-entry-form">
                        <p class="text-gray-600 dark:text-gray-300 mb-6">برای شرکت در آزمون، کد آزمون را وارد کنید.</p>
                        
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <label for="quiz-code" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">کد آزمون</label>
                                <input type="text" id="quiz-code" name="quiz-code" placeholder="کد آزمون را وارد کنید..." 
                                    class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div class="flex items-end">
                                <button id="find-quiz-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 h-[42px]">
                                    جستجو
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-8">
                            <label for="participant-name" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">نام و نام خانوادگی</label>
                            <input type="text" id="participant-name" name="participant-name" placeholder="نام و نام خانوادگی خود را وارد کنید..." 
                                class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button id="start-quiz-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300" disabled>
                                شروع آزمون
                            </button>
                        </div>
                    </div>
                    
                    <div id="quiz-details" class="hidden">
                        <div class="border-b border-gray-200 dark:border-gray-700 pb-4 mb-6">
                            <h3 id="quiz-info-title" class="text-xl font-bold text-gray-800 dark:text-white mb-2"></h3>
                            <p id="quiz-info-description" class="text-gray-600 dark:text-gray-300"></p>
                            <div class="flex flex-wrap gap-x-6 gap-y-2 mt-4 text-sm text-gray-600 dark:text-gray-400">
                                <div class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <span id="quiz-info-questions">تعداد سوالات: <span class="font-medium"></span></span>
                                </div>
                                <div class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span id="quiz-info-time">زمان: <span class="font-medium"></span> دقیقه</span>
                                </div>
                                <div class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span id="quiz-info-passing">نمره قبولی: <span class="font-medium"></span>%</span>
                                </div>
                                <div class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                                    </svg>
                                    <span id="quiz-info-attempts">محدودیت شرکت: <span class="font-medium"></span></span>
                                </div>
                            </div>
                        </div>
                        <div id="attempts-error" class="hidden mt-4 p-4 bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200 rounded-lg">
                            <p class="font-bold">شما قبلاً در این آزمون شرکت کرده‌اید و به حداکثر تعداد دفعات مجاز رسیده‌اید.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Taking View -->
            <div id="quiz-taking-view" class="hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="quiz-title-header" class="text-2xl font-bold text-gray-800 dark:text-white"></h2>
                        <div class="flex items-center bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200 px-4 py-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span id="quiz-timer" class="font-bold"></span>
                        </div>
                    </div>
                    
                    <div class="border-b border-gray-200 dark:border-gray-700 mb-6 pb-6">
                        <div class="flex justify-between items-center">
                            <div id="quiz-progress" class="text-gray-600 dark:text-gray-300 mb-2">سوال <span id="current-question">1</span> از <span id="total-questions"></span></div>
                            <div id="quiz-score" class="text-gray-600 dark:text-gray-300">امتیاز: <span class="font-bold">0</span></div>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-primary-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="question-container" class="mb-8">
                        <div id="question-media" class="mb-4 hidden">
                            <!-- Media content will be inserted here -->
                        </div>
                        <h3 id="question-text" class="text-xl font-bold text-gray-800 dark:text-white mb-4"></h3>
                        <div id="options-container" class="space-y-3">
                            <!-- Options will be added here dynamically -->
                        </div>
                    </div>
                    
                    <div class="flex justify-between">
                        <button id="prev-question-btn" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-bold py-2 px-6 rounded-lg transition duration-300" disabled>
                            سوال قبلی
                        </button>
                        <button id="next-question-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                            سوال بعدی
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results View -->
            <div id="results-view" class="hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">نتیجه آزمون</h2>
                        <button id="back-to-home-from-results" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div id="results-summary" class="text-center p-6 border-b border-gray-200 dark:border-gray-700 mb-6">
                        <div id="pass-badge" class="hidden mx-auto mb-4 w-24 h-24 flex items-center justify-center rounded-full bg-green-100 dark:bg-green-900">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-600 dark:text-green-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div id="fail-badge" class="hidden mx-auto mb-4 w-24 h-24 flex items-center justify-center rounded-full bg-red-100 dark:bg-red-900">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-600 dark:text-red-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </div>
                        <h3 id="result-status" class="text-2xl font-bold text-gray-800 dark:text-white mb-2"></h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-4">نمره شما: <span id="final-score" class="font-bold"></span> از <span id="total-score" class="font-bold"></span> (<span id="score-percentage" class="font-bold"></span>%)</p>
                        <p class="text-gray-600 dark:text-gray-300">زمان صرف شده: <span id="time-spent" class="font-bold"></span></p>
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">جزئیات سوالات</h3>
                    <div id="question-details" class="space-y-6">
                        <!-- Question details will be added here dynamically -->
                    </div>
                    
                    <div class="mt-8 flex justify-center">
                        <button id="share-results-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                            اشتراک‌گذاری نتیجه
                        </button>
                    </div>
                </div>
            </div>

            <!-- My Quizzes View -->
            <div id="my-quizzes-view" class="hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">آزمون‌های من</h2>
                        <button id="back-from-my-quizzes" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div id="quizzes-list" class="space-y-4">
                        <!-- Quizzes will be listed here -->
                        <div id="no-quizzes" class="text-center py-8 text-gray-500 dark:text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>هنوز هیچ آزمونی نساخته‌اید</p>
                            <button id="create-first-quiz-btn" class="mt-4 text-primary-600 dark:text-primary-400 font-medium">
                                ساخت اولین آزمون
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Details View -->
            <div id="quiz-details-view" class="hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="quiz-details-title" class="text-2xl font-bold text-gray-800 dark:text-white"></h2>
                        <button id="back-from-quiz-details" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-4 mb-6">
                        <p id="quiz-details-description" class="text-gray-600 dark:text-gray-300 mb-4"></p>
                        <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-600 dark:text-gray-400">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span>تاریخ ایجاد: <span id="quiz-details-date" class="font-medium"></span></span>
                            </div>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>تعداد سوالات: <span id="quiz-details-questions-count" class="font-medium"></span></span>
                            </div>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>زمان: <span id="quiz-details-time" class="font-medium"></span> دقیقه</span>
                            </div>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>نمره قبولی: <span id="quiz-details-passing" class="font-medium"></span>%</span>
                            </div>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                                </svg>
                                <span>محدودیت شرکت: <span id="quiz-details-attempts" class="font-medium"></span></span>
                            </div>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                <span>تعداد شرکت‌کنندگان: <span id="quiz-details-participants" class="font-medium">0</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4 text-center">
                            <div class="text-xl font-bold text-gray-800 dark:text-white">کد آزمون</div>
                            <div id="quiz-details-code" class="mt-2 bg-gray-100 dark:bg-gray-600 p-2 rounded font-mono text-primary-600 dark:text-primary-300"></div>
                            <button id="copy-code-from-details-btn" class="mt-3 bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded text-sm">
                                کپی کد
                            </button>
                            <button id="share-quiz-btn" class="mt-3 mr-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">
                                اشتراک‌گذاری
                            </button>
                        </div>
                        <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4">
                            <div class="text-xl font-bold text-gray-800 dark:text-white text-center mb-2">عملیات</div>
                            <div class="grid grid-cols-2 gap-4">
                                <button id="export-quiz-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                                    دانلود دیتابیس
                                </button>
                                <button id="delete-quiz-from-details-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                                    حذف آزمون
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">نتایج شرکت‌کنندگان</h3>
                        <div id="participants-results" class="overflow-x-auto">
                            <div id="no-participants" class="text-center py-8 text-gray-500 dark:text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                <p>هنوز هیچ‌کس در این آزمون شرکت نکرده است</p>
                            </div>
                            <table id="results-table" class="hidden w-full table-auto">
                                <thead class="bg-gray-100 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-2 text-right text-gray-800 dark:text-white">#</th>
                                        <th class="px-4 py-2 text-right text-gray-800 dark:text-white">نام</th>
                                        <th class="px-4 py-2 text-right text-gray-800 dark:text-white">درصد</th>
                                        <th class="px-4 py-2 text-right text-gray-800 dark:text-white">نمره</th>
                                        <th class="px-4 py-2 text-right text-gray-800 dark:text-white">وضعیت</th>
                                        <th class="px-4 py-2 text-right text-gray-800 dark:text-white">تاریخ</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body">
                                    <!-- Results will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Share View -->
            <div id="share-view" class="hidden fade-in">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">اشتراک‌گذاری آزمون</h2>
                        <button id="back-from-share" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="text-center p-6 mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-primary-600 dark:text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                        </svg>
                        <h3 id="share-quiz-title" class="text-xl font-bold text-gray-800 dark:text-white mb-2"></h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-6">کد آزمون را با شرکت‌کنندگان به اشتراک بگذارید</p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-8 text-center mb-8">
                        <div class="text-xl font-bold text-gray-800 dark:text-white mb-4">کد آزمون</div>
                        <div id="share-quiz-code" class="mb-4 p-6 rounded font-mono text-4xl text-primary-600 dark:text-primary-300 bg-gray-100 dark:bg-gray-600"></div>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">برای شرکت در آزمون، کد بالا را به شرکت‌کنندگان ارائه دهید</p>
                        <button id="copy-code-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg text-base">
                            کپی کد آزمون
                        </button>
                    </div>
                    
                    <div class="text-center">
                        <button id="view-quiz-details-btn" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                            مشاهده جزئیات آزمون
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Alert Container -->
            <div id="alert-container" class="fixed left-0 right-0 bottom-4 flex justify-center z-50">
                <div id="alert" class="hidden rounded-lg p-4 shadow-lg max-w-md transition-all duration-300 transform translate-y-10 opacity-0"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check dark mode preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            
            // Global variables
            let currentView = 'home-view';
            let currentQuiz = null;
            let currentQuestion = 0;
            let userAnswers = [];
            let answeredQuestions = []; // Keep track of answered questions
            let quizStartTime = null;
            let quizEndTime = null;
            let quizTimer = null;
            let quizDuration = 0;
            let timeRemaining = 0;
            let SQL = null;
            let db = null;
            let sqljsConfig = {
                locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${filename}`
            };
            
            // Initialize SQL.js
            initSqlJs(sqljsConfig).then(function(sql) {
                SQL = sql;
                
                // Create a new database
                db = new SQL.Database();
                
                // Initialize the database schema
                initDatabase();
                
                // Hide loading view and show main views
                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('views').classList.remove('hidden');
                
                // Initially show home view
                switchView('home-view');
                
                // Initialize the app (attach event listeners, etc.)
                init();
                
                console.log("Database initialized successfully!");
            }).catch(err => {
                console.error("Error initializing SQL.js:", err);
                showAlert("خطا در بارگیری پایگاه داده. لطفا صفحه را مجدداً بارگذاری کنید.", "error");
            });
            
            // Initialize database schema
            function initDatabase() {
                // Create quizzes table
                db.run(`
                    CREATE TABLE IF NOT EXISTS quizzes (
                        id TEXT PRIMARY KEY,
                        code TEXT UNIQUE NOT NULL,
                        title TEXT NOT NULL,
                        description TEXT,
                        time INTEGER NOT NULL,
                        passingScore INTEGER NOT NULL,
                        maxAttempts INTEGER DEFAULT 0,
                        createdAt TEXT NOT NULL
                    )
                `);
                
                // Create questions table
                db.run(`
                    CREATE TABLE IF NOT EXISTS questions (
                        id TEXT PRIMARY KEY,
                        quizId TEXT NOT NULL,
                        text TEXT NOT NULL,
                        mediaType TEXT,
                        mediaData TEXT,
                        position INTEGER NOT NULL,
                        FOREIGN KEY (quizId) REFERENCES quizzes(id) ON DELETE CASCADE
                    )
                `);
                
                // Create options table
                db.run(`
                    CREATE TABLE IF NOT EXISTS options (
                        id TEXT PRIMARY KEY,
                        questionId TEXT NOT NULL,
                        text TEXT NOT NULL,
                        isCorrect INTEGER NOT NULL,
                        position INTEGER NOT NULL,
                        FOREIGN KEY (questionId) REFERENCES questions(id) ON DELETE CASCADE
                    )
                `);
                
                // Create participants table
                db.run(`
                    CREATE TABLE IF NOT EXISTS participants (
                        id TEXT PRIMARY KEY,
                        quizId TEXT NOT NULL,
                        name TEXT NOT NULL,
                        score INTEGER NOT NULL,
                        totalQuestions INTEGER NOT NULL,
                        timeSpent INTEGER NOT NULL,
                        passed INTEGER NOT NULL,
                        date TEXT NOT NULL,
                        FOREIGN KEY (quizId) REFERENCES quizzes(id) ON DELETE CASCADE
                    )
                `);
                
                // Create answers table
                db.run(`
                    CREATE TABLE IF NOT EXISTS answers (
                        participantId TEXT NOT NULL,
                        questionId TEXT NOT NULL,
                        optionId TEXT,
                        FOREIGN KEY (participantId) REFERENCES participants(id) ON DELETE CASCADE,
                        FOREIGN KEY (questionId) REFERENCES questions(id) ON DELETE CASCADE,
                        FOREIGN KEY (optionId) REFERENCES options(id) ON DELETE CASCADE,
                        PRIMARY KEY (participantId, questionId)
                    )
                `);
            }
            
            // Helper function to generate a unique ID
            function generateUniqueId() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            
            // Helper function to generate a quiz code
            function generateQuizCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }
            
            // Helper function to format date
            function formatDate(date) {
                const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                return new Date(date).toLocaleDateString('fa-IR', options);
            }
            
            // Helper function to format time
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
            
            // Show alert message
            function showAlert(message, type = 'success') {
                const alertEl = document.getElementById('alert');
                alertEl.textContent = message;
                
                if (type === 'success') {
                    alertEl.className = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded-lg p-4 shadow-lg max-w-md';
                } else if (type === 'error') {
                    alertEl.className = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 rounded-lg p-4 shadow-lg max-w-md';
                } else if (type === 'info') {
                    alertEl.className = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-lg p-4 shadow-lg max-w-md';
                }
                
                // Show the alert
                alertEl.classList.remove('hidden', 'opacity-0', 'translate-y-10');
                alertEl.classList.add('opacity-100', 'translate-y-0');
                
                // Hide the alert after 3 seconds
                setTimeout(() => {
                    alertEl.classList.add('opacity-0', 'translate-y-10');
                    setTimeout(() => {
                        alertEl.classList.add('hidden');
                    }, 300);
                }, 3000);
            }
            
            // Switch between views
            function switchView(viewId) {
                document.getElementById(currentView).classList.add('hidden');
                document.getElementById(viewId).classList.remove('hidden');
                currentView = viewId;
                
                // Scroll to top
                window.scrollTo(0, 0);
            }
            
            // Add a new question to the quiz form
            function addQuestion(questionData = null) {
                const questionsContainer = document.getElementById('questions-container');
                const questionIndex = questionsContainer.children.length;
                
                const questionDiv = document.createElement('div');
                questionDiv.className = 'p-4 border border-gray-200 dark:border-gray-700 rounded-lg question-item';
                questionDiv.dataset.index = questionIndex;
                
                const questionText = questionData ? questionData.text : '';
                const mediaType = questionData ? (questionData.mediaType || '') : '';
                const mediaData = questionData ? (questionData.mediaData || '') : '';
                
                // Build HTML for the question
                let html = `
                    <div class="flex justify-between items-start mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 font-medium">سوال ${questionIndex + 1}</label>
                        <button type="button" class="text-red-500 hover:text-red-700 remove-question-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 font-medium mb-2">فایل رسانه‌ای (اختیاری)</label>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <select class="media-type w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="" ${mediaType === '' ? 'selected' : ''}>بدون فایل رسانه‌ای</option>
                                    <option value="image" ${mediaType === 'image' ? 'selected' : ''}>تصویر</option>
                                    <option value="video" ${mediaType === 'video' ? 'selected' : ''}>ویدیو</option>
                                    <option value="audio" ${mediaType === 'audio' ? 'selected' : ''}>صوت</option>
                                    <option value="text" ${mediaType === 'text' ? 'selected' : ''}>متن</option>
                                </select>
                            </div>
                            <div class="media-file-container flex-1 ${mediaType === '' ? 'hidden' : ''}">
                                ${mediaType === 'image' || mediaType === 'video' || mediaType === 'audio' ? 
                                    `<input type="file" class="media-file w-full px-4 py-1.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white file:mr-4 file:py-1 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 dark:file:bg-primary-900 dark:file:text-primary-300 hover:file:bg-primary-100 dark:hover:file:bg-primary-800">` : 
                                    mediaType === 'text' ? 
                                    `<textarea class="media-text w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" rows="3">${mediaData}</textarea>` : 
                                    ''}
                            </div>
                        </div>
                        <div class="media-preview mt-3 ${!mediaData ? 'hidden' : ''}">
                            ${mediaType === 'image' ? `<img src="${mediaData}" class="max-h-48 mx-auto rounded-lg border border-gray-200 dark:border-gray-700">` : ''}
                            ${mediaType === 'video' ? `<video src="${mediaData}" controls class="max-h-48 mx-auto rounded-lg border border-gray-200 dark:border-gray-700"></video>` : ''}
                            ${mediaType === 'audio' ? `<audio src="${mediaData}" controls class="w-full"></audio>` : ''}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 font-medium mb-2">متن سوال</label>
                        <input type="text" placeholder="متن سوال را وارد کنید..." value="${questionText}" required
                            class="question-text w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    
                    <div class="mb-1">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-gray-700 dark:text-gray-300 font-medium">گزینه‌ها</label>
                            <div class="options-count text-gray-600 dark:text-gray-400 text-sm">تعداد گزینه‌ها: <span>4</span>/10</div>
                        </div>
                        <div class="space-y-3 options-container">`;
                
                // Adding options
                const options = questionData && questionData.options ? questionData.options : [{ text: '', isCorrect: true }, { text: '', isCorrect: false }, { text: '', isCorrect: false }, { text: '' , isCorrect: false }];
                
                options.forEach((option, idx) => {
                    html += `
                        <div class="flex items-center option-container">
                            <input type="radio" name="correct-option-${questionIndex}" value="${idx}" ${option.isCorrect ? 'checked' : ''}
                                class="w-4 h-4 text-primary-600 border-gray-300 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600">
                            <input type="text" placeholder="گزینه ${idx + 1}" value="${option.text}"
                                class="option-text ml-2 flex-1 px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            ${idx > 1 ? `
                            <button type="button" class="remove-option-btn ml-2 text-red-500 hover:text-red-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <button type="button" class="add-option-btn mt-3 inline-flex items-center text-primary-600 dark:text-primary-400 font-medium ${options.length >= 10 ? 'hidden' : ''}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            افزودن گزینه
                        </button>
                    </div>
                `;
                
                questionDiv.innerHTML = html;
                questionsContainer.appendChild(questionDiv);
                
                // Add event listener to remove question button
                questionDiv.querySelector('.remove-question-btn').addEventListener('click', function() {
                    if (confirm('آیا از حذف این سوال اطمینان دارید؟')) {
                        questionDiv.remove();
                        updateQuestionNumbers();
                    }
                });
                
                // Add event listener to add option button
                const addOptionBtn = questionDiv.querySelector('.add-option-btn');
                const optionsContainer = questionDiv.querySelector('.options-container');
                const optionsCountEl = questionDiv.querySelector('.options-count span');
                
                addOptionBtn.addEventListener('click', function() {
                    const optionContainers = optionsContainer.querySelectorAll('.option-container');
                    const optionCount = optionContainers.length;
                    
                    if (optionCount < 10) {
                        const newOption = document.createElement('div');
                        newOption.className = 'flex items-center option-container';
                        newOption.innerHTML = `
                            <input type="radio" name="correct-option-${questionIndex}" value="${optionCount}"
                                class="w-4 h-4 text-primary-600 border-gray-300 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600">
                            <input type="text" placeholder="گزینه ${optionCount + 1}"
                                class="option-text ml-2 flex-1 px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <button type="button" class="remove-option-btn ml-2 text-red-500 hover:text-red-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        `;
                        
                        optionsContainer.appendChild(newOption);
                        
                        // Add event listener to remove option button
                        newOption.querySelector('.remove-option-btn').addEventListener('click', function() {
                            newOption.remove();
                            updateOptionNumbers(questionDiv);
                        });
                        
                        // Update option count
                        optionsCountEl.textContent = optionContainers.length + 1;
                        
                        // Hide add option button if reached max
                        if (optionContainers.length + 1 >= 10) {
                            addOptionBtn.classList.add('hidden');
                        }
                    }
                });
                
                // Add event listeners to existing remove option buttons
                questionDiv.querySelectorAll('.remove-option-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        btn.closest('.option-container').remove();
                        updateOptionNumbers(questionDiv);
                    });
                });
                
                // Add event listener to media type select
                const mediaTypeSelect = questionDiv.querySelector('.media-type');
                const mediaFileContainer = questionDiv.querySelector('.media-file-container');
                const mediaPreview = questionDiv.querySelector('.media-preview');
                
                mediaTypeSelect.addEventListener('change', function() {
                    const mediaType = this.value;
                    
                    // Clear existing media input
                    mediaFileContainer.innerHTML = '';
                    mediaPreview.innerHTML = '';
                    mediaPreview.classList.add('hidden');
                    
                    if (mediaType === '') {
                        mediaFileContainer.classList.add('hidden');
                    } else {
                        mediaFileContainer.classList.remove('hidden');
                        
                        if (mediaType === 'text') {
                            mediaFileContainer.innerHTML = `
                                <textarea class="media-text w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" rows="3"></textarea>
                            `;
                        } else {
                            // For image, video, audio types
                            mediaFileContainer.innerHTML = `
                                <input type="file" class="media-file w-full px-4 py-1.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white file:mr-4 file:py-1 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 dark:file:bg-primary-900 dark:file:text-primary-300 hover:file:bg-primary-100 dark:hover:file:bg-primary-800">
                            `;
                            
                            if (mediaType === 'image') {
                                mediaFileContainer.querySelector('.media-file').accept = "image/*";
                            } else if (mediaType === 'video') {
                                mediaFileContainer.querySelector('.media-file').accept = "video/*";
                            } else if (mediaType === 'audio') {
                                mediaFileContainer.querySelector('.media-file').accept = "audio/*";
                            }
                            
                            // Add event listener to file input
                            mediaFileContainer.querySelector('.media-file').addEventListener('change', function() {
                                if (this.files && this.files[0]) {
                                    const file = this.files[0];
                                    const reader = new FileReader();
                                    
                                    reader.onload = function(e) {
                                        const fileData = e.target.result;
                                        
                                        mediaPreview.innerHTML = '';
                                        mediaPreview.classList.remove('hidden');
                                        
                                        if (mediaType === 'image') {
                                            mediaPreview.innerHTML = `<img src="${fileData}" class="max-h-48 mx-auto rounded-lg border border-gray-200 dark:border-gray-700">`;
                                        } else if (mediaType === 'video') {
                                            mediaPreview.innerHTML = `<video src="${fileData}" controls class="max-h-48 mx-auto rounded-lg border border-gray-200 dark:border-gray-700"></video>`;
                                        } else if (mediaType === 'audio') {
                                            mediaPreview.innerHTML = `<audio src="${fileData}" controls class="w-full"></audio>`;
                                        }
                                    };
                                    
                                    reader.readAsDataURL(file);
                                }
                            });
                        }
                    }
                });
                
                // If there is existing media data, set up the text area change listener
                if (mediaType === 'text' && mediaData) {
                    const mediaTextarea = questionDiv.querySelector('.media-text');
                    if (mediaTextarea) {
                        mediaTextarea.value = mediaData;
                    }
                }
            }
            
            // Update question numbers after removing a question
            function updateQuestionNumbers() {
                const questions = document.querySelectorAll('.question-item');
                questions.forEach((question, index) => {
                    question.dataset.index = index;
                    question.querySelector('label').textContent = `سوال ${index + 1}`;
                    const radios = question.querySelectorAll('input[type="radio"]');
                    radios.forEach(radio => {
                        radio.name = `correct-option-${index}`;
                    });
                });
            }
            
            // Update option numbers within a question
            function updateOptionNumbers(questionEl) {
                const optionsContainer = questionEl.querySelector('.options-container');
                const options = optionsContainer.querySelectorAll('.option-container');
                const optionsCountEl = questionEl.querySelector('.options-count span');
                const addOptionBtn = questionEl.querySelector('.add-option-btn');
                
                // Update count display
                optionsCountEl.textContent = options.length;
                
                // Show/hide add option button
                if (options.length < 10) {
                    addOptionBtn.classList.remove('hidden');
                } else {
                    addOptionBtn.classList.add('hidden');
                }
                
                // Update radio values and option placeholders
                options.forEach((option, idx) => {
                    option.querySelector('input[type="radio"]').value = idx;
                    option.querySelector('input[type="text"]').placeholder = `گزینه ${idx + 1}`;
                });
            }
            
            // Get media data from question element
            function getMediaDataFromQuestion(questionEl) {
                const mediaType = questionEl.querySelector('.media-type').value;
                let mediaData = '';
                
                if (mediaType === 'text') {
                    const textArea = questionEl.querySelector('.media-text');
                    if (textArea) {
                        mediaData = textArea.value;
                    }
                } else if (mediaType && mediaType !== '') {
                    const preview = questionEl.querySelector('.media-preview');
                    if (preview && !preview.classList.contains('hidden')) {
                        if (mediaType === 'image') {
                            const img = preview.querySelector('img');
                            if (img) mediaData = img.src;
                        } else if (mediaType === 'video') {
                            const video = preview.querySelector('video');
                            if (video) mediaData = video.src;
                        } else if (mediaType === 'audio') {
                            const audio = preview.querySelector('audio');
                            if (audio) mediaData = audio.src;
                        }
                    }
                }
                
                return { mediaType, mediaData };
            }
            
            // Save quiz to database
            function saveQuiz(quizData) {
                try {
                    db.run('BEGIN TRANSACTION');
                    
                    // Insert quiz
                    db.run(
                        'INSERT INTO quizzes (id, code, title, description, time, passingScore, maxAttempts, createdAt) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
                        [
                            quizData.id,
                            quizData.code,
                            quizData.title,
                            quizData.description,
                            quizData.time,
                            quizData.passingScore,
                            quizData.maxAttempts,
                            quizData.createdAt
                        ]
                    );
                    
                    // Insert questions and options
                    quizData.questions.forEach((question, qIndex) => {
                        const questionId = generateUniqueId();
                        
                        // Insert question
                        db.run(
                            'INSERT INTO questions (id, quizId, text, mediaType, mediaData, position) VALUES (?, ?, ?, ?, ?, ?)',
                            [
                                questionId,
                                quizData.id,
                                question.text,
                                question.mediaType || null,
                                question.mediaData || null,
                                qIndex
                            ]
                        );
                        
                        // Insert options
                        question.options.forEach((option, oIndex) => {
                            const optionId = generateUniqueId();
                            db.run(
                                'INSERT INTO options (id, questionId, text, isCorrect, position) VALUES (?, ?, ?, ?, ?)',
                                [
                                    optionId,
                                    questionId,
                                    option.text,
                                    option.isCorrect ? 1 : 0,
                                    oIndex
                                ]
                            );
                        });
                    });
                    
                    db.run('COMMIT');
                    return true;
                } catch (error) {
                    db.run('ROLLBACK');
                    console.error("Error saving quiz:", error);
                    return false;
                }
            }
            
            // Get quiz by ID
            function getQuizById(id) {
                try {
                    // Get basic quiz info
                    const quizStmt = db.prepare('SELECT * FROM quizzes WHERE id = ?');
                    quizStmt.bind([id]);
                    
                    if (!quizStmt.step()) {
                        quizStmt.free();
                        return null;
                    }
                    
                    const quizRow = quizStmt.getAsObject();
                    quizStmt.free();
                    
                    const quiz = {
                        id: quizRow.id,
                        code: quizRow.code,
                        title: quizRow.title,
                        description: quizRow.description,
                        time: quizRow.time,
                        passingScore: quizRow.passingScore,
                        maxAttempts: quizRow.maxAttempts,
                        createdAt: quizRow.createdAt,
                        questions: []
                    };
                    
                    // Get questions
                    const questionsStmt = db.prepare('SELECT * FROM questions WHERE quizId = ? ORDER BY position');
                    questionsStmt.bind([id]);
                    
                    while (questionsStmt.step()) {
                        const questionRow = questionsStmt.getAsObject();
                        
                        const question = {
                            id: questionRow.id,
                            text: questionRow.text,
                            mediaType: questionRow.mediaType,
                            mediaData: questionRow.mediaData,
                            options: []
                        };
                        
                        // Get options for this question
                        const optionsStmt = db.prepare('SELECT * FROM options WHERE questionId = ? ORDER BY position');
                        optionsStmt.bind([questionRow.id]);
                        
                        while (optionsStmt.step()) {
                            const optionRow = optionsStmt.getAsObject();
                            
                            question.options.push({
                                id: optionRow.id,
                                text: optionRow.text,
                                isCorrect: optionRow.isCorrect === 1
                            });
                        }
                        
                        optionsStmt.free();
                        quiz.questions.push(question);
                    }
                    
                    questionsStmt.free();
                    
                    // Get participants count
                    const countStmt = db.prepare('SELECT COUNT(*) as count FROM participants WHERE quizId = ?');
                    countStmt.bind([id]);
                    countStmt.step();
                    const participantsCount = countStmt.getAsObject().count;
                    countStmt.free();
                    
                    quiz.participantsCount = participantsCount;
                    
                    return quiz;
                } catch (error) {
                    console.error("Error getting quiz by ID:", error);
                    return null;
                }
            }
            
            // Get quiz by code
            function getQuizByCode(code) {
                try {
                    // Get quiz ID from code
                    const stmt = db.prepare('SELECT id FROM quizzes WHERE code = ?');
                    stmt.bind([code]);
                    
                    if (!stmt.step()) {
                        stmt.free();
                        return null;
                    }
                    
                    const quizId = stmt.getAsObject().id;
                    stmt.free();
                    
                    // Use getQuizById to get full quiz details
                    return getQuizById(quizId);
                } catch (error) {
                    console.error("Error getting quiz by code:", error);
                    return null;
                }
            }
            
            // Get participant attempts for a quiz
            function getParticipantAttempts(quizId, participantName) {
                try {
                    const stmt = db.prepare('SELECT COUNT(*) as count FROM participants WHERE quizId = ? AND name = ?');
                    stmt.bind([quizId, participantName]);
                    stmt.step();
                    const count = stmt.getAsObject().count;
                    stmt.free();
                    return count;
                } catch (error) {
                    console.error("Error getting participant attempts:", error);
                    return 0;
                }
            }
            
            // Save quiz result
            function saveQuizResult(quizId, result) {
                try {
                    db.run('BEGIN TRANSACTION');
                    
                    // Insert participant
                    db.run(
                        'INSERT INTO participants (id, quizId, name, score, totalQuestions, timeSpent, passed, date) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
                        [
                            result.id,
                            quizId,
                            result.participantName,
                            result.score,
                            result.totalQuestions,
                            result.timeSpent,
                            result.passed ? 1 : 0,
                            result.date
                        ]
                    );
                    
                    // Insert answers
                    if (result.answers && result.answers.length > 0) {
                        result.answers.forEach(answer => {
                            if (answer.questionId && answer.optionId) {
                                db.run(
                                    'INSERT INTO answers (participantId, questionId, optionId) VALUES (?, ?, ?)',
                                    [result.id, answer.questionId, answer.optionId]
                                );
                            }
                        });
                    }
                    
                    db.run('COMMIT');
                    return true;
                } catch (error) {
                    db.run('ROLLBACK');
                    console.error("Error saving quiz result:", error);
                    return false;
                }
            }
            
            // Get quiz results
            function getQuizResults(quizId) {
                try {
                    const results = [];
                    
                    const stmt = db.prepare('SELECT * FROM participants WHERE quizId = ? ORDER BY date DESC');
                    stmt.bind([quizId]);
                    
                    while (stmt.step()) {
                        const row = stmt.getAsObject();
                        
                        results.push({
                            id: row.id,
                            participantName: row.name,
                            score: row.score,
                            totalQuestions: row.totalQuestions,
                            percentage: Math.round((row.score / row.totalQuestions) * 100),
                            timeSpent: row.timeSpent,
                            passed: row.passed === 1,
                            date: row.date
                        });
                    }
                    
                    stmt.free();
                    return results;
                } catch (error) {
                    console.error("Error getting quiz results:", error);
                    return [];
                }
            }
            
            // Get all quizzes
            function getAllQuizzes() {
                try {
                    const quizzes = [];
                    
                    const stmt = db.prepare('SELECT * FROM quizzes ORDER BY createdAt DESC');
                    
                    while (stmt.step()) {
                        const row = stmt.getAsObject();
                        
                        // Get participants count
                        const countStmt = db.prepare('SELECT COUNT(*) as count FROM participants WHERE quizId = ?');
                        countStmt.bind([row.id]);
                        countStmt.step();
                        const participantsCount = countStmt.getAsObject().count;
                        countStmt.free();
                        
                        // Get questions count
                        const questionsStmt = db.prepare('SELECT COUNT(*) as count FROM questions WHERE quizId = ?');
                        questionsStmt.bind([row.id]);
                        questionsStmt.step();
                        const questionsCount = questionsStmt.getAsObject().count;
                        questionsStmt.free();
                        
                        quizzes.push({
                            id: row.id,
                            code: row.code,
                            title: row.title,
                            description: row.description,
                            time: row.time,
                            passingScore: row.passingScore,
                            maxAttempts: row.maxAttempts,
                            createdAt: row.createdAt,
                            participantsCount: participantsCount,
                            questionsCount: questionsCount
                        });
                    }
                    
                    stmt.free();
                    return quizzes;
                } catch (error) {
                    console.error("Error getting all quizzes:", error);
                    return [];
                }
            }
            
            // Delete quiz
            function deleteQuiz(quizId) {
                try {
                    db.run('BEGIN TRANSACTION');
                    
                    // Delete quiz (foreign key constraints will handle deleting related data)
                    db.run('DELETE FROM quizzes WHERE id = ?', [quizId]);
                    
                    db.run('COMMIT');
                    return true;
                } catch (error) {
                    db.run('ROLLBACK');
                    console.error("Error deleting quiz:", error);
                    return false;
                }
            }
            
            // Export database
            function exportDatabase() {
                try {
                    const data = db.export();
                    const blob = new Blob([data], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Quiz.db';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    return true;
                } catch (error) {
                    console.error("Error exporting database:", error);
                    return false;
                }
            }
            
            // Format attempts display
            function formatAttemptsDisplay(maxAttempts) {
                if (maxAttempts === 0) {
                    return "بدون محدودیت";
                } else if (maxAttempts === 1) {
                    return "فقط یک بار";
                } else {
                    return `${maxAttempts} بار`;
                }
            }
            
            // Start quiz
            function startQuiz(quiz, participantName) {
                currentQuiz = quiz;
                currentQuestion = 0;
                userAnswers = [];
                answeredQuestions = [];
                quizStartTime = new Date();
                quizDuration = quiz.time * 60; // Convert minutes to seconds
                timeRemaining = quizDuration;
                
                // Initialize answers array
                quiz.questions.forEach(question => {
                    userAnswers.push({
                        questionId: question.id,
                        optionId: null
                    });
                });
                
                // Set quiz title
                document.getElementById('quiz-title-header').textContent = quiz.title;
                
                // Set total questions
                document.getElementById('total-questions').textContent = quiz.questions.length;
                
                // Start the timer
                startTimer();
                
                // Show the first question
                showQuestion(currentQuestion);
                
                // Switch to quiz taking view
                switchView('quiz-taking-view');
            }
            
            // Show question
            function showQuestion(index) {
                const question = currentQuiz.questions[index];
                document.getElementById('current-question').textContent = index + 1;
                document.getElementById('question-text').textContent = question.text;
                
                // Update progress bar
                const progressPercentage = ((index + 1) / currentQuiz.questions.length) * 100;
                document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
                
                // Show or hide media content
                const mediaContainer = document.getElementById('question-media');
                if (question.mediaType && question.mediaData) {
                    mediaContainer.classList.remove('hidden');
                    mediaContainer.innerHTML = '';
                    
                    if (question.mediaType === 'image') {
                        mediaContainer.innerHTML = `<img src="${question.mediaData}" class="max-w-full max-h-80 mx-auto rounded-lg border border-gray-200 dark:border-gray-700">`;
                    } else if (question.mediaType === 'video') {
                        mediaContainer.innerHTML = `<video src="${question.mediaData}" controls class="max-w-full max-h-80 mx-auto rounded-lg border border-gray-200 dark:border-gray-700"></video>`;
                    } else if (question.mediaType === 'audio') {
                        mediaContainer.innerHTML = `<audio src="${question.mediaData}" controls class="w-full"></audio>`;
                    } else if (question.mediaType === 'text') {
                        mediaContainer.innerHTML = `<div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-200">${question.mediaData}</div>`;
                    }
                } else {
                    mediaContainer.classList.add('hidden');
                }
                
                // Clear previous options
                const optionsContainer = document.getElementById('options-container');
                optionsContainer.innerHTML = '';
                
                // Check if this question has been answered
                const isAnswered = answeredQuestions.includes(index);
                const userAnswer = userAnswers[index];
                
                // Add options
                question.options.forEach((option) => {
                    const optionDiv = document.createElement('div');
                    const isSelected = userAnswer.optionId === option.id;
                    
                    optionDiv.className = `p-3 border ${isSelected ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20' : 'border-gray-200 dark:border-gray-700'} rounded-lg ${isAnswered ? '' : 'cursor-pointer option-container hover:bg-gray-50 dark:hover:bg-gray-700/50'} transition duration-150`;
                    optionDiv.innerHTML = `
                        <div class="flex items-center">
                            <div class="flex-shrink-0 mr-2">
                                <div class="w-5 h-5 rounded-full border-2 ${isSelected ? 'border-primary-500 bg-primary-500' : 'border-gray-300 dark:border-gray-600'} flex items-center justify-center">
                                    ${isSelected ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>' : ''}
                                </div>
                            </div>
                            <span>${option.text}</span>
                        </div>
                    `;
                    
                    // Add click event listener if question is not already answered
                    if (!isAnswered) {
                        optionDiv.addEventListener('click', function() {
                            // Set the user's answer
                            userAnswers[index].optionId = option.id;
                            
                            // Update the UI to show the selected option
                            const options = optionsContainer.querySelectorAll('div');
                            options.forEach((opt, idx) => {
                                if (opt === optionDiv) {
                                    opt.classList.add('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
                                    opt.classList.remove('border-gray-200', 'dark:border-gray-700');
                                    opt.querySelector('div > div').classList.add('border-primary-500', 'bg-primary-500');
                                    opt.querySelector('div > div').classList.remove('border-gray-300', 'dark:border-gray-600');
                                    opt.querySelector('div > div').innerHTML = '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>';
                                } else {
                                    opt.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
                                    opt.classList.add('border-gray-200', 'dark:border-gray-700');
                                    opt.querySelector('div > div').classList.remove('border-primary-500', 'bg-primary-500');
                                    opt.querySelector('div > div').classList.add('border-gray-300', 'dark:border-gray-600');
                                    opt.querySelector('div > div').innerHTML = '';
                                }
                            });
                        });
                    }
                    
                    optionsContainer.appendChild(optionDiv);
                });
                
                // Enable/disable previous/next buttons
                document.getElementById('prev-question-btn').disabled = index === 0;
                
                if (index === currentQuiz.questions.length - 1) {
                    document.getElementById('next-question-btn').textContent = 'پایان آزمون';
                } else {
                    document.getElementById('next-question-btn').textContent = 'سوال بعدی';
                }
            }
            
            // Start timer
            function startTimer() {
                if (quizTimer) {
                    clearInterval(quizTimer);
                }
                
                const timerElement = document.getElementById('quiz-timer');
                timerElement.textContent = formatTime(timeRemaining);
                
                quizTimer = setInterval(function() {
                    timeRemaining--;
                    
                    if (timeRemaining <= 0) {
                        clearInterval(quizTimer);
                        endQuiz();
                    } else {
                        timerElement.textContent = formatTime(timeRemaining);
                        
                        // Change color when less than 1 minute remains
                        if (timeRemaining < 60) {
                            timerElement.classList.add('text-red-600', 'dark:text-red-400');
                        }
                    }
                }, 1000);
            }
            
            // End quiz
            function endQuiz() {
                clearInterval(quizTimer);
                quizEndTime = new Date();
                
                // Calculate score
                let score = 0;
                
                // Find correct options and calculate score
                currentQuiz.questions.forEach((question, index) => {
                    const userAnswer = userAnswers[index];
                    if (userAnswer.optionId) {
                        // Find the selected option in the question
                        const selectedOption = question.options.find(option => option.id === userAnswer.optionId);
                        if (selectedOption && selectedOption.isCorrect) {
                            score++;
                        }
                    }
                });
                
                // Calculate time spent
                const timeSpent = Math.floor((quizEndTime - quizStartTime) / 1000);
                
                // Calculate percentage
                const percentage = Math.round((score / currentQuiz.questions.length) * 100);
                
                // Determine if passed
                const passed = percentage >= currentQuiz.passingScore;
                
                // Create result object
                const result = {
                    id: generateUniqueId(),
                    participantName: document.getElementById('participant-name').value,
                    score: score,
                    totalQuestions: currentQuiz.questions.length,
                    timeSpent: timeSpent,
                    passed: passed,
                    date: new Date().toISOString(),
                    answers: userAnswers
                };
                
                // Save the result
                if (saveQuizResult(currentQuiz.id, result)) {
                    // Show results
                    showResults(result);
                } else {
                    showAlert("خطا در ذخیره نتیجه آزمون!", "error");
                }
            }
            
            // Show results
            function showResults(result) {
                // Set result status
                document.getElementById('result-status').textContent = result.passed ? 'تبریک! شما در آزمون قبول شدید' : 'متأسفانه شما در آزمون رد شدید';
                
                // Show appropriate badge
                if (result.passed) {
                    document.getElementById('pass-badge').classList.remove('hidden');
                    document.getElementById('fail-badge').classList.add('hidden');
                } else {
                    document.getElementById('pass-badge').classList.add('hidden');
                    document.getElementById('fail-badge').classList.remove('hidden');
                }
                
                // Set scores
                document.getElementById('final-score').textContent = result.score;
                document.getElementById('total-score').textContent = result.totalQuestions;
                document.getElementById('score-percentage').textContent = Math.round((result.score / result.totalQuestions) * 100);
                
                // Set time spent
                const minutes = Math.floor(result.timeSpent / 60);
                const seconds = result.timeSpent % 60;
                document.getElementById('time-spent').textContent = `${minutes} دقیقه و ${seconds} ثانیه`;
                
                // Show question details
                const questionDetails = document.getElementById('question-details');
                questionDetails.innerHTML = '';
                
                currentQuiz.questions.forEach((question, index) => {
                    const userAnswer = result.answers[index];
                    let isCorrect = false;
                    let selectedOption = null;
                    let correctOption = null;
                    
                    // Find selected option and correct option
                    if (userAnswer.optionId) {
                        selectedOption = question.options.find(opt => opt.id === userAnswer.optionId);
                        correctOption = question.options.find(opt => opt.isCorrect);
                        
                        if (selectedOption && correctOption) {
                            isCorrect = selectedOption.id === correctOption.id;
                        }
                    } else {
                        correctOption = question.options.find(opt => opt.isCorrect);
                    }
                    
                    const questionDiv = document.createElement('div');
                    questionDiv.className = `p-4 border ${isCorrect ? 'border-green-200 dark:border-green-800' : 'border-red-200 dark:border-red-800'} rounded-lg`;
                    
                    let mediaHTML = '';
                    if (question.mediaType && question.mediaData) {
                        if (question.mediaType === 'image') {
                            mediaHTML = `<div class="mb-3"><img src="${question.mediaData}" class="max-h-48 mx-auto rounded-lg border border-gray-200 dark:border-gray-700"></div>`;
                        } else if (question.mediaType === 'video') {
                            mediaHTML = `<div class="mb-3"><video src="${question.mediaData}" controls class="max-h-48 mx-auto rounded-lg border border-gray-200 dark:border-gray-700"></video></div>`;
                        } else if (question.mediaType === 'audio') {
                            mediaHTML = `<div class="mb-3"><audio src="${question.mediaData}" controls class="w-full"></audio></div>`;
                        } else if (question.mediaType === 'text') {
                            mediaHTML = `<div class="mb-3 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-200">${question.mediaData}</div>`;
                        }
                    }
                    
                    questionDiv.innerHTML = `
                        <div class="flex items-start">
                            <div class="flex-shrink-0 mr-3">
                                <div class="w-6 h-6 flex items-center justify-center rounded-full ${isCorrect ? 'bg-green-100 dark:bg-green-900 text-green-500 dark:text-green-300' : 'bg-red-100 dark:bg-red-900 text-red-500 dark:text-red-300'}">
                                    ${isCorrect ? 
                                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>' : 
                                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>'
                                    }
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800 dark:text-white mb-2">سوال ${index + 1}: ${question.text}</h4>
                                ${mediaHTML}
                                <div class="space-y-2 mb-2">
                                    ${question.options.map(option => `
                                        <div class="flex items-center">
                                            <div class="w-4 h-4 mr-2 rounded-full ${
                                                option.isCorrect ? 'bg-green-500 dark:bg-green-400' : 
                                                (selectedOption && option.id === selectedOption.id) ? 'bg-red-500 dark:bg-red-400' : 
                                                'bg-gray-200 dark:bg-gray-700'
                                            }"></div>
                                            <span class="${
                                                option.isCorrect ? 'font-medium text-green-600 dark:text-green-400' : 
                                                (selectedOption && option.id === selectedOption.id) ? 'font-medium text-red-600 dark:text-red-400' : 
                                                'text-gray-600 dark:text-gray-400'
                                            }">${option.text}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">
                                    ${isCorrect ? 'پاسخ صحیح است' : `پاسخ صحیح: ${correctOption ? correctOption.text : 'بدون پاسخ'}`}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    questionDetails.appendChild(questionDiv);
                });
                
                // Switch to results view
                switchView('results-view');
            }
            
            // Initialize quiz form
            function initQuizForm() {
                // Clear existing questions
                document.getElementById('questions-container').innerHTML = '';
                
                // Reset form
                document.getElementById('quiz-form').reset();
                
                // Add first question with 4 default options
                addQuestion();
            }
            
            // List user's quizzes
            function listQuizzes() {
                const quizzesList = document.getElementById('quizzes-list');
                const quizzes = getAllQuizzes();
                
                // Show no quizzes message if there are no quizzes
                if (quizzes.length === 0) {
                    document.getElementById('no-quizzes').classList.remove('hidden');
                    return;
                }
                
                // Hide no quizzes message
                document.getElementById('no-quizzes').classList.add('hidden');
                
                // Clear the list
                quizzesList.innerHTML = '';
                
                // Add each quiz to the list
                quizzes.forEach(quiz => {
                    const quizDiv = document.createElement('div');
                    quizDiv.className = 'bg-white dark:bg-gray-700 rounded-lg shadow p-4 flex flex-col md:flex-row items-center justify-between';
                    
                    quizDiv.innerHTML = `
                        <div class="mb-4 md:mb-0">
                            <h3 class="text-lg font-bold text-gray-800 dark:text-white">${quiz.title}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">کد: ${quiz.code} | تاریخ ایجاد: ${formatDate(quiz.createdAt)}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">تعداد سوالات: ${quiz.questionsCount} | شرکت‌کنندگان: ${quiz.participantsCount}</p>
                        </div>
                        <div class="flex space-x-2 rtl:space-x-reverse">
                            <button class="view-quiz-btn bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg text-sm" data-id="${quiz.id}">
                                مشاهده
                            </button>
                            <button class="share-quiz-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm" data-id="${quiz.id}">
                                اشتراک
                            </button>
                            <button class="delete-quiz-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm" data-id="${quiz.id}">
                                حذف
                            </button>
                        </div>
                    `;
                    
                    quizzesList.appendChild(quizDiv);
                });
                
                // Add event listeners to buttons
                quizzesList.querySelectorAll('.view-quiz-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const quizId = this.dataset.id;
                        showQuizDetails(quizId);
                    });
                });
                
                quizzesList.querySelectorAll('.share-quiz-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const quizId = this.dataset.id;
                        showShareView(quizId);
                    });
                });
                
                quizzesList.querySelectorAll('.delete-quiz-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const quizId = this.dataset.id;
                        deleteQuizConfirm(quizId);
                    });
                });
            }
            
            // Delete quiz with confirmation
            function deleteQuizConfirm(quizId) {
                if (confirm('آیا از حذف این آزمون اطمینان دارید؟\nتمام اطلاعات آزمون و نتایج شرکت‌کنندگان حذف خواهد شد.')) {
                    if (deleteQuiz(quizId)) {
                        showAlert("آزمون با موفقیت حذف شد", "success");
                        // Refresh the list
                        listQuizzes();
                    } else {
                        showAlert("خطا در حذف آزمون", "error");
                    }
                }
            }
            
            // Show quiz details
            function showQuizDetails(quizId) {
                const quiz = getQuizById(quizId);
                if (!quiz) {
                    showAlert("خطا در بارگذاری اطلاعات آزمون", "error");
                    return;
                }
                
                // Set quiz details
                document.getElementById('quiz-details-title').textContent = quiz.title;
                document.getElementById('quiz-details-description').textContent = quiz.description;
                document.getElementById('quiz-details-date').textContent = formatDate(quiz.createdAt);
                document.getElementById('quiz-details-questions-count').textContent = quiz.questions.length;
                document.getElementById('quiz-details-time').textContent = quiz.time;
                document.getElementById('quiz-details-passing').textContent = quiz.passingScore;
                document.getElementById('quiz-details-attempts').textContent = formatAttemptsDisplay(quiz.maxAttempts);
                document.getElementById('quiz-details-code').textContent = quiz.code;
                
                // Set participants count
                const participantsCount = quiz.participantsCount || 0;
                document.getElementById('quiz-details-participants').textContent = participantsCount;
                
                // Set current quiz ID for buttons
                document.getElementById('share-quiz-btn').dataset.id = quiz.id;
                document.getElementById('export-quiz-btn').dataset.id = quiz.id;
                document.getElementById('delete-quiz-from-details-btn').dataset.id = quiz.id;
                
                // Show results table if there are participants
                if (participantsCount > 0) {
                    document.getElementById('no-participants').classList.add('hidden');
                    document.getElementById('results-table').classList.remove('hidden');
                    
                    // Get quiz results
                    const results = getQuizResults(quiz.id);
                    
                    // Clear the table body
                    const tableBody = document.getElementById('results-table-body');
                    tableBody.innerHTML = '';
                    
                    // Add each participant to the table
                    results.forEach((result, index) => {
                        const row = document.createElement('tr');
                        row.className = index % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700';
                        
                        row.innerHTML = `
                            <td class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">${index + 1}</td>
                            <td class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">${result.participantName}</td>
                            <td class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">${result.percentage}%</td>
                            <td class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">${result.score} از ${result.totalQuestions}</td>
                            <td class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
                                <span class="px-2 py-1 rounded text-xs font-medium ${result.passed ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200'}">
                                    ${result.passed ? 'قبول' : 'رد'}
                                </span>
                            </td>
                            <td class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">${formatDate(result.date)}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                } else {
                    document.getElementById('no-participants').classList.remove('hidden');
                    document.getElementById('results-table').classList.add('hidden');
                }
                
                // Switch to quiz details view
                switchView('quiz-details-view');
            }
            
            // Show share view
            function showShareView(quizId) {
                const quiz = getQuizById(quizId);
                if (!quiz) {
                    showAlert("خطا در بارگذاری اطلاعات آزمون", "error");
                    return;
                }
                
                // Set quiz title
                document.getElementById('share-quiz-title').textContent = quiz.title;
                
                // Set quiz code
                document.getElementById('share-quiz-code').textContent = quiz.code;
                
                // Set view quiz details button
                document.getElementById('view-quiz-details-btn').dataset.id = quiz.id;
                
                // Switch to share view
                switchView('share-view');
            }
            
            // Show quiz info for taking quiz
            function showQuizInfo(quiz) {
                document.getElementById('quiz-info-title').textContent = quiz.title;
                document.getElementById('quiz-info-description').textContent = quiz.description;
                document.getElementById('quiz-info-questions').querySelector('span').textContent = quiz.questions.length;
                document.getElementById('quiz-info-time').querySelector('span').textContent = quiz.time;
                document.getElementById('quiz-info-passing').querySelector('span').textContent = quiz.passingScore;
                document.getElementById('quiz-info-attempts').querySelector('span').textContent = formatAttemptsDisplay(quiz.maxAttempts);
                
                document.getElementById('quiz-details').classList.remove('hidden');
                
                // Check if participant has reached the maximum number of attempts
                const participantName = document.getElementById('participant-name').value;
                if (participantName && quiz.maxAttempts > 0) {
                    const attempts = getParticipantAttempts(quiz.id, participantName);
                    
                    if (attempts >= quiz.maxAttempts) {
                        document.getElementById('attempts-error').classList.remove('hidden');
                        document.getElementById('start-quiz-btn').disabled = true;
                        return;
                    } else {
                        document.getElementById('attempts-error').classList.add('hidden');
                    }
                } else {
                    document.getElementById('attempts-error').classList.add('hidden');
                }
                
                document.getElementById('start-quiz-btn').disabled = !document.getElementById('participant-name').value;
            }
            
            // Initialize the application
            function init() {
                // Event listeners for navigation
                document.getElementById('create-quiz-btn').addEventListener('click', function() {
                    switchView('create-quiz-view');
                    initQuizForm();
                });
                
                document.getElementById('take-quiz-btn').addEventListener('click', function() {
                    switchView('take-quiz-view');
                });
                
                document.getElementById('my-quizzes-btn').addEventListener('click', function() {
                    switchView('my-quizzes-view');
                    listQuizzes();
                });
                
                document.getElementById('back-to-home-btn').addEventListener('click', function() {
                    switchView('home-view');
                });
                
                document.getElementById('back-from-take-quiz').addEventListener('click', function() {
                    switchView('home-view');
                });
                
                document.getElementById('back-from-my-quizzes').addEventListener('click', function() {
                    switchView('home-view');
                });
                
                document.getElementById('back-from-quiz-details').addEventListener('click', function() {
                    switchView('my-quizzes-view');
                    listQuizzes();
                });
                
                document.getElementById('back-from-share').addEventListener('click', function() {
                    switchView('my-quizzes-view');
                    listQuizzes();
                });
                
                document.getElementById('back-to-home-from-results').addEventListener('click', function() {
                    switchView('home-view');
                });
                
                document.getElementById('create-first-quiz-btn').addEventListener('click', function() {
                    switchView('create-quiz-view');
                    initQuizForm();
                });
                
                // Add question button
                document.getElementById('add-question-btn').addEventListener('click', function() {
                    addQuestion();
                });
                
                // Quiz form submission
                document.getElementById('quiz-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const title = document.getElementById('quiz-title').value;
                    const description = document.getElementById('quiz-description').value;
                    const time = parseInt(document.getElementById('quiz-time').value);
                    const passingScore = parseInt(document.getElementById('quiz-passing-score').value);
                    const maxAttempts = parseInt(document.getElementById('quiz-attempts').value);
                    
                    // Get questions
                    const questions = [];
                    let hasErrors = false;
                    
                    document.querySelectorAll('.question-item').forEach(questionEl => {
                        const questionText = questionEl.querySelector('.question-text').value;
                        
                        if (!questionText) {
                            showAlert("لطفاً متن تمام سوالات را وارد کنید", "error");
                            hasErrors = true;
                            return;
                        }
                        
                        // Get media data
                        const { mediaType, mediaData } = getMediaDataFromQuestion(questionEl);
                        
                        // Get options
                        const options = [];
                        let hasCorrectOption = false;
                        
                        questionEl.querySelectorAll('.option-container').forEach(optionEl => {
                            const optionText = optionEl.querySelector('.option-text').value;
                            const isCorrect = optionEl.querySelector('input[type="radio"]').checked;
                            
                            if (!optionText) {
                                showAlert("لطفاً متن تمام گزینه‌ها را وارد کنید", "error");
                                hasErrors = true;
                                return;
                            }
                            
                            options.push({
                                text: optionText,
                                isCorrect: isCorrect
                            });
                            
                            if (isCorrect) {
                                hasCorrectOption = true;
                            }
                        });
                        
                        if (!hasCorrectOption) {
                            showAlert("لطفاً برای هر سوال یک گزینه صحیح انتخاب کنید", "error");
                            hasErrors = true;
                            return;
                        }
                        
                        questions.push({
                            text: questionText,
                            mediaType: mediaType,
                            mediaData: mediaData,
                            options: options
                        });
                    });
                    
                    if (hasErrors) {
                        return;
                    }
                    
                    // Validate
                    if (questions.length === 0) {
                        showAlert('حداقل یک سوال اضافه کنید', 'error');
                        return;
                    }
                    
                    // Create quiz object
                    const quizId = generateUniqueId();
                    const quizCode = generateQuizCode();
                    
                    const quiz = {
                        id: quizId,
                        code: quizCode,
                        title: title,
                        description: description,
                        time: time,
                        passingScore: passingScore,
                        maxAttempts: maxAttempts,
                        createdAt: new Date().toISOString(),
                        questions: questions
                    };
                    
                    // Save the quiz
                    if (saveQuiz(quiz)) {
                        showAlert('آزمون با موفقیت ساخته شد', 'success');
                        // Show share view
                        showShareView(quizId);
                    } else {
                        showAlert('خطا در ذخیره آزمون!', 'error');
                    }
                });
                
                // Find quiz button
                document.getElementById('find-quiz-btn').addEventListener('click', function() {
                    const quizCode = document.getElementById('quiz-code').value;
                    if (!quizCode) {
                        showAlert('کد آزمون را وارد کنید', 'error');
                        return;
                    }
                    
                    const quiz = getQuizByCode(quizCode);
                    if (quiz) {
                        showQuizInfo(quiz);
                    } else {
                        showAlert('آزمون مورد نظر یافت نشد', 'error');
                    }
                });
                
                // Participant name input
                document.getElementById('participant-name').addEventListener('input', function() {
                    const quizCode = document.getElementById('quiz-code').value;
                    if (quizCode) {
                        const quiz = getQuizByCode(quizCode);
                        if (quiz) {
                            // Check attempts limit
                            if (quiz.maxAttempts > 0) {
                                const attempts = getParticipantAttempts(quiz.id, this.value);
                                if (attempts >= quiz.maxAttempts) {
                                    document.getElementById('attempts-error').classList.remove('hidden');
                                    document.getElementById('start-quiz-btn').disabled = true;
                                    return;
                                } else {
                                    document.getElementById('attempts-error').classList.add('hidden');
                                }
                            }
                        }
                    }
                    
                    document.getElementById('start-quiz-btn').disabled = !this.value;
                });
                
                // Start quiz button
                document.getElementById('start-quiz-btn').addEventListener('click', function() {
                    const quizCode = document.getElementById('quiz-code').value;
                    const participantName = document.getElementById('participant-name').value;
                    
                    if (!quizCode) {
                        showAlert('کد آزمون را وارد کنید', 'error');
                        return;
                    }
                    
                    if (!participantName) {
                        showAlert('نام خود را وارد کنید', 'error');
                        return;
                    }
                    
                    const quiz = getQuizByCode(quizCode);
                    if (!quiz) {
                        showAlert('آزمون مورد نظر یافت نشد', 'error');
                        return;
                    }
                    
                    // Check attempts limit
                    if (quiz.maxAttempts > 0) {
                        const attempts = getParticipantAttempts(quiz.id, participantName);
                        if (attempts >= quiz.maxAttempts) {
                            showAlert('شما قبلاً در این آزمون شرکت کرده‌اید و به حداکثر تعداد دفعات مجاز رسیده‌اید.', 'error');
                            return;
                        }
                    }
                    
                    startQuiz(quiz, participantName);
                });
                
                // Previous question button
                document.getElementById('prev-question-btn').addEventListener('click', function() {
                    if (currentQuestion > 0) {
                        currentQuestion--;
                        showQuestion(currentQuestion);
                    }
                });
                
                // Next question button
                document.getElementById('next-question-btn').addEventListener('click', function() {
                    // Mark current question as answered if an option is selected
                    if (userAnswers[currentQuestion].optionId && !answeredQuestions.includes(currentQuestion)) {
                        answeredQuestions.push(currentQuestion);
                    }
                    
                    if (currentQuestion < currentQuiz.questions.length - 1) {
                        currentQuestion++;
                        showQuestion(currentQuestion);
                    } else {
                        endQuiz();
                    }
                });
                
                // View quiz details button
                document.getElementById('view-quiz-details-btn').addEventListener('click', function() {
                    const quizId = this.dataset.id;
                    showQuizDetails(quizId);
                });
                
                // Copy code buttons
                document.getElementById('copy-code-btn').addEventListener('click', function() {
                    const code = document.getElementById('share-quiz-code').textContent;
                    navigator.clipboard.writeText(code).then(function() {
                        showAlert('کد آزمون کپی شد', 'success');
                    }).catch(function() {
                        // Fallback for browsers that don't support clipboard API
                        const tempInput = document.createElement('input');
                        tempInput.value = code;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showAlert('کد آزمون کپی شد', 'success');
                    });
                });
                
                document.getElementById('copy-code-from-details-btn').addEventListener('click', function() {
                    const code = document.getElementById('quiz-details-code').textContent;
                    navigator.clipboard.writeText(code).then(function() {
                        showAlert('کد آزمون کپی شد', 'success');
                    }).catch(function() {
                        // Fallback
                        const tempInput = document.createElement('input');
                        tempInput.value = code;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showAlert('کد آزمون کپی شد', 'success');
                    });
                });
                
                // Share quiz button (from details view)
                document.getElementById('share-quiz-btn').addEventListener('click', function() {
                    const quizId = this.dataset.id;
                    showShareView(quizId);
                });
                
                // Export database button
                document.getElementById('export-quiz-btn').addEventListener('click', function() {
                    if (exportDatabase()) {
                        showAlert('دیتابیس با موفقیت دانلود شد', 'success');
                    } else {
                        showAlert('خطا در دانلود دیتابیس', 'error');
                    }
                });
                
                // Delete quiz button (from details view)
                document.getElementById('delete-quiz-from-details-btn').addEventListener('click', function() {
                    const quizId = this.dataset.id;
                    deleteQuizConfirm(quizId);
                });
                
                // Share results button
                document.getElementById('share-results-btn').addEventListener('click', function() {
                    const resultText = `نتیجه آزمون: ${document.getElementById('final-score').textContent} از ${document.getElementById('total-score').textContent} (${document.getElementById('score-percentage').textContent}%)`;
                    
                    navigator.clipboard.writeText(resultText).then(function() {
                        showAlert('نتیجه آزمون کپی شد', 'success');
                    }).catch(function() {
                        // Fallback
                        const tempInput = document.createElement('input');
                        tempInput.value = resultText;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showAlert('نتیجه آزمون کپی شد', 'success');
                    });
                });
            }
        });
    </script>
</body>
</html>
